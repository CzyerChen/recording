> 关于代理也是了解过一些，关于正向代理、反向代理、代理模式，今天主要聊一聊反向代理和负载均衡

- 反向代理就是隐藏了服务节点的主要信息，用户只是知道请求了一个地址，但具体的请求详情并不能知道
- 反向代理在服务网关的构建中利用的很多，它能够便捷轻量的实现，请求的转发、请求的过滤、请求的限制，请求的负载分发等
- 负载均衡的方式有比较多，有分硬件负载均衡和软件负载均衡，硬件会比较贵，运维会繁重一些，软件相对灵活，不过效果总是有限的
- LVS、nginx、haproxy是比较常见的
- 以下主要介绍一下它们的负载均衡原理，以及它们的一些优缺点，主要介绍nginx


### LVS --- 传输层的负载均衡
- LVS 是 Linux Virtual Server 的简称，也就是 Linux 虚拟服务器
- 现在 LVS 已经是 Linux 标准内核的一部分，从 Linux2.4 内核以后完全内置了 LVS，无需给内核打任何补丁，可以直接使用 LVS 提供的各种功能

#### 架构设计
- 由三部分组成：负载均衡层，服务集群层，共享存储层
- LVS是四层负载均衡，是在传输层上进行，主要面向TCP/UDP，无需解析等，效率高
- 由于是4层，主要就是通过报文中的目的地址和端口，主要就是修改IP、修改目标MAC实现转发
- 它有NAT（Net Address Transform）网络地址转换模式，主要用于内外网地址映射，经过转换修改IP和Mac ,它就能够将请求转入内网处理（SNAT-源网络地址转换），内网处理完毕返回后再转为外网IP（DNAT-目标网络地址转换）
- 它有DR（Direct Router）直接路由模式，主要就是LVS将报文转发了，不会修改IP，只修改MAC，服务器处理完直接返回给用户，不经过LVS，和NAT模式有较大区别。它处理消息后直接返回，避免负载均衡服务器网卡带宽成为瓶颈，DR 模式具有较好的性能，也是目前大型网站使用最广泛的一种负载均衡手段

#### 优点
1. 在传输层分发，没有流量产生
2. 负载均衡能力强，效率高，cpu消耗低
3. 可配置性差，但稳定性比较高，可以使用lvs+keepalive
4. 应用范围比较广,工作在传输层,可以对所有应用做负载均衡

#### 缺点
1. 不能做动静分离
2. 大型网站搭设复杂度高，LVS/DR + Keepalived


### Nginx 
- 强大的 Web 服务器软件，用于处理高并发的 HTTP 请求和作为反向代理服务器做负载均衡
- 高性能、轻量级、内存消耗少，有强大的负载均衡能力

#### 架构设计
- nginx底层的通信原理和netty很像，采用单线程多路复用的模型，实现消息的准确转发，也大大提高了吞吐量
- 采用模块化的、基于事件驱动、异步、单线程且非阻塞
- master用于接收外部信号，给worker发送信号，监控worker状态，一个worker一个时刻只能处理一个请求
- nginx的负载均衡策略很多
```text
轮询（默认）：每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器 down 掉，能自动剔除。

weight：指定轮询几率，weight 和访问比率成正比，用于后端服务器性能不均的情况。

ip_hash：每个请求按访问 ip 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决 session 的问题。

fair（第三方）：按后端服务器的响应时间来分配请求，响应时间短的优先分配。

url_hash（第三方）：按访问 url 的 hash 结果来分配请求，使每个 url 定向到同一个后端服务器，后端服务器为缓存时比较有效。
```
- 一般web请求都会需要session，因而ip_hash是最常用的策略

#### 优点
- 跨平台
- 高并发、非阻塞，可以支持2-3万并发连接
- 配置简单
- 事件驱动，通信机制采用 epoll 模型，支持更大的并发连接
- master worker 风格，提供端口监控，服务宕机自动删除
- 支持gzip压缩，支持请求头缓存，节省带宽
- 稳定性高，基本不会宕机

#### 缺点
- 仅能支持http、https 和 Email 协议，也不能说是缺点，一件事情做专了才能做好
- 对后端服务器的健康检查，只支持通过端口来检测，不支持通过 ur l来检测
- 不支持 Session 的直接保持，但能通过 ip_hash策略解决


### HAProxy
- HAProxy 支持两种代理模式 TCP（四层）和HTTP（七层），也是支持虚拟主机的
- 支持 Session 的保持，Cookie 的引导；同时支持通过获取指定的 url 来检测后端服务器的状态,这个是nginx达不到的
- 更像LVS，支持TCP协议的负载均衡转发，策略有：Round-robin（轮循）、Weight-round-robin（带权轮循）、source（原地址保持）、RI（请求URL）、rdp-cookie（根据cookie）

### 最佳实践组合：Nginx+HAProxy+Keepalive
[学习Nignx从入门到精通](http://tengine.taobao.org/book/index.html),可以一起来学一下